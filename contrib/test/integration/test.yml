---

- name: clone build and install cri-tools
  include: "build/cri-tools.yml"

- name: Make testing output verbose so it can be converted to xunit
  lineinfile:
    dest: "{{ go_path }}/src/k8s.io/kubernetes/hack/make-rules/test.sh"
    line: ' go test -v "${goflags[@]:+${goflags[@]}}" \'
    regexp: ' go test \"\$'
    state: present

- name: set extra storage options
  set_fact:
    extra_storage_opts: " --storage-opt overlay.override_kernel_check=1"
  when: ansible_distribution == 'RedHat' or ansible_distribution == 'CentOS'

- name: ensure directory exists for integration results
  file:
    path: "{{ artifacts }}"
    state: directory

- name: run integration tests
  shell: "make localintegration >& {{ artifacts }}/testout.txt"
  args:
    chdir: "{{ cri_o_dest_path }}"
  async: 5400
  poll: 30
