---

- name: Make sure we have all required packages
  package:
    name: "redhat-rpm-config, rpm-build, yum-utils, iptables"
    state: present
  async: '{{ 10 * 60 }}'
  poll: 10

- name: Add Btrfs for Fedora
  package:
    name: "{{ item }}"
    state: present
  with_items:
   - btrfs-progs-devel
  when: ansible_distribution in ['Fedora']

- name: Update all packages
  package:
    name: '*'
    state: latest
  async: 600
  poll: 10

- name: inject hostname into /etc/hosts
  lineinfile:
    dest: /etc/hosts
    line: '{{ ansible_default_ipv4.address }} {{ ansible_nodename }}'
    insertafter: 'EOF'
    regexp: '{{ ansible_default_ipv4.address }}\s+{{ ansible_nodename }}'
    state: present

- name: Flush the iptables
  command: iptables -F

- name: Enable localnet routing
  command: sysctl -w net.ipv4.conf.all.route_localnet=1

- name: Add masquerade for localhost
  command: iptables -t nat -I POSTROUTING -s 127.0.0.1 ! -d 127.0.0.1 -j MASQUERADE

- name: Update the kernel cmdline to include quota support
  command: grubby --update-kernel=ALL --args="rootflags=pquota"
  when: ansible_distribution in ['RedHat', 'CentOS']
